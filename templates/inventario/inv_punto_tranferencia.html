{% extends 'base.html' %}
{% block headcss %}
    <link rel="stylesheet" href="/static/css/easy-autocomplete.min.css">
    <style>
        .blink {
            animation: blinker 1s step-start infinite;
        }

        @keyframes blinker {
            50% {
                opacity: 0;
            }
        }

        @media (min-width: 992px) {

            .gedf-card {
                margin-bottom: 2.77rem;
            }
        }

        .easy-autocomplete input {
            border-radius: 0;
        }

        #id-table-buscar-filtro tbody {
            display: block;
            height: 280px;
            overflow: auto;
        }

        #id-table-buscar-filtro thead, #id-table-buscar-filtro tbody tr {
            display: table;
            width: 100%;
            table-layout: fixed;
        }

        #id-table-buscar-filtro tbody tr {
            cursor: pointer;
        }

        table.table-hover tbody tr:hover {
            background-color: #b8daff;
        }
    </style>
{% endblock %}
{% block header %}
    {% include 'header.html' %}
{% endblock %}
{% block main %}
    <div class="container-fluid" style="margin-top: 2.8rem">
        <div class="row">
            <article class="col">
                <div class="card mb-5">
                    <div class="card-header p-1">
                        <div class="btn-toolbar justify-content-between">
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-secondary btn-sm" type="button" id="btnAdd" data-toggle="tooltip"
                                        data-placement="top" title="Nueva factura" disabled>
                                    <i class="fa fa-plus"></i> <span
                                        class="d-none d-sm-block d-sm-none"><b>NUEVO [F1]</b></span>
                                </button>

                                <button type="button"
                                        onclick="if(confirm('Desea cancelar la factura')){ window.location.reload();}"
                                        class="btn btn-danger btn-sm" id="id-btn-cancelar-documento"
                                        data-toggle="tooltip"
                                        data-placement="top" title="Cancelar documento de venta">
                                    <i class="fa fa-ban"></i> <span
                                        class="d-none d-sm-block d-sm-none"><b>CANCELAR [ESC]</b></span>
                                </button>

                                <button class="btn btn-success btn-sm" type="button" id="id-btn-guardar-factura"
                                        data-toggle="tooltip"
                                        data-placement="top" title="Guardar documento de venta" {% if transferencia.procesado %}disabled{% endif %}>
                                    <i class="fa fa-save"></i> <span
                                        class="d-none d-sm-block d-sm-none"><b>GUARDAR [F2]</b></span>
                                </button>

                            </div>
                            <div class="lower bg-dark text-white p-0 m-0 text-center">
                                <div class="d-flex flex-column p-1" style="font-size: 11px">
                                    <b>TOTAL</b>
                                </div>
                                <div class="pl-2 pr-2 m-0" style="width: 16rem">
                                    <span class="h5" style="color: #01ff70;font-family:'Arial Black'"
                                          id="id-total-pagar-display">
                                        $0.00
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-1">
                        <fieldset class="tab-content m-0" id="myTabContent">
                            <div class="tab-pane fade show active" id="tab1" role="tabpanel">
                                <div class="form-row">
                                    <div class="col-md-3 col-6">
                                        <div class="input-group input-group mt-1 id-click-fecha">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text">
                                                    <i class="fa fa-calendar"></i>
                                                </span>
                                            </div>
                                            <input type="text" id="id-fecha" name="fecha"
                                                   value="{{ transferencia.fecha|date:"d/m/Y" }}"
                                                   class="form-control bg-white" data-toggle-date="datepicker"
                                                   data-toggle="tooltip" data-placement="top" title="Fecha de factura"
                                                   required
                                                   readonly>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-6">
                                        <div class="input-group input-group mt-1">
                                            <div class="input-group-prepend">
                                        <span class="input-group-text">
                                            <b>Empresa</b>
                                        </span>
                                            </div>
                                            <select class="custom-select">
                                                <option value="">---------</option>
                                                {% for d in divisiones %}
                                                    <option
                                                            value="{{ d.id }}"
                                                            {% if d.id == transferencia.division.id %}
                                                            selected
                                                            {% endif %}
                                                    >{{ d.nombre }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-6">
                                        <div class="input-group input-group mt-1">
                                            <div class="input-group-prepend">
                                        <span class="input-group-text">
                                            <b>Sucursal</b>
                                        </span>
                                            </div>
                                            <input type="text" id="id-bodega" name="bodega"
                                                   value="{{ sucursal.codigo }}-{{ sucursal.nombre }}"
                                                   class="form-control bg-white" readonly>
                                        </div>
                                    </div>
                                    <div class="col-md-2 col-6">
                                        <div class="input-group input-group mt-1">
                                            <div class="input-group-prepend">
                                        <span class="input-group-text">
                                            <b>Tipo</b>
                                        </span>
                                            </div>
                                            <input type="text" value="{{ transferencia.tipo }}"
                                                   class="form-control bg-white" readonly>
                                        </div>
                                    </div>

                                    <div class="col-md-1 col-6">
                                        <h5 class="mt-2">
                                            <span class="badge badge-{% if transferencia.estado == '1' %}warning{% elif transferencia.estado == '2' %}success{% else %}danger{% endif %} btn-block p-2">
                                                {{ transferencia.get_estado_display }}
                                            </span>
                                        </h5>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="col-md-3 col-6">
                                        <div class="input-group input-group mt-1">
                                            <div class="input-group-prepend">
                                        <span class="input-group-text">
                                            <b>B.Origen</b>
                                        </span>
                                            </div>
                                            <select class="custom-select" id="id-bodega-origen" disabled>
                                                <option value="">---------</option>
                                                {% for b in bodegas_origen %}
                                                    <option
                                                            value="{{ b.id }}"
                                                            {% if b.id == transferencia.bodega_origen.id %}
                                                            selected
                                                            {% endif %}
                                                    >{{ b.nombre }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-6">
                                        <div class="input-group input-group mt-1">
                                            <div class="input-group-prepend">
                                        <span class="input-group-text">
                                            <b>B.Destino</b>
                                        </span>
                                            </div>
                                            <select class="custom-select" id="id-bodega-destino">
                                                <option value="">---------</option>
                                                {% for b in bodegas_destino %}
                                                    <option value="{{ b.id }}"
                                                            {% if b.id == transferencia.bodega_destino.id %}
                                                            selected
                                                            {% endif %}>
                                                        {{ b.nombre }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col">
                                        <div class="input-group input-group mt-1">
                                            <div class="input-group-prepend">
                                        <span class="input-group-text">
                                            <b>Detalle</b>
                                        </span>
                                            </div>
                                            <input type="text" id="id-detalle" class="form-control" value="{{ transferencia.detalle }}">
                                        </div>
                                    </div>
                                </div>
                                <form id="id-form-producto-codigo-barra">
                                    <div class="form-row">
                                        <div class="col-md-3 mt-1">
                                            <div class="input-group">
                                                <div class="input-group-prepend">
                                                    <span class="input-group-text" id="basic-addon1">
                                                        <i class="fa fa-barcode"></i>
                                                    </span>
                                                </div>
                                                <input type="text" id="id-input-codigo-barra" name="codigo"
                                                       class="form-control" placeholder="Código de barra"
                                                       autocomplete="off" required disabled>
                                                <div class="input-group-append">
                                                    <button class="btn btn-success" data-toggle="tooltip"
                                                            data-placement="top" title="Agregar producto">
                                                        <i class="fa fa-plus-circle"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md mt-1">
                                            <div class="input-group input-group-sm">
                                                <div class="input-group-prepend">
                                                    <span class="input-group-text">
                                                        <i class="fa fa-cubes"></i>
                                                    </span>
                                                </div>
                                                <input type="text" rel="seleccion" id="id-filter-producto"
                                                       class="form-control"
                                                       placeholder="Buscar producto por descripción" disabled>
                                                <div class="input-group-append">
                                                    <button type="button" id="id-btn-show-modal-buscar"
                                                            class="btn btn-primary" data-toggle="modal"
                                                            data-target="#id-modal-buscar-productos">
                                                        <i class="fa fa-search"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                                <div id="id-contenedor-detalle-transferencia" class="row">
                                    <div class="col-md-12 mt-1">
                                        <table id="id-table-detalle-transferencia"
                                               class="table table-bordered table-hover table-striped table-sm p-0"
                                               style="border: solid 1px #ccc">
                                            <thead class="text-center text-sm-center thead-dark small"
                                                   style="font-size: 13px">
                                            <tr>
                                                <th>Cod.</th>
                                                <th>Producto</th>
                                                <th>Formato</th>
                                                <th>Stock</th>
                                                <th>Cant.</th>
                                                <th>Emp.</th>
                                                <th>Unds.</th>
                                                <th>Costo Unt.</th>
                                                <th>Total</th>
                                                <th class="p-0" align="center" width="10">
                                                    <button type="button" onclick="modelo.eliminar_lista();"
                                                            class="btn btn-danger btn-sm p-1 m-0"
                                                            title="Eliminar detalle">
                                                        <i class="fa fa-minus-circle"></i>
                                                    </button>
                                                </th>
                                            </tr>
                                            </thead>
                                            <tbody style="font-size: 12px">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md">
                                        <table class="table table-striped table-sm sm-0 m-0 p-0 table-light"
                                               id="tab_logic_total">
                                            <tbody>
                                            <tr style="font-size: 12px;" class="bg-gradient-primary text-white">
                                                <td colspan="2">
                                                    <b class="text-white">Items:</b>
                                                    <span id="id-items-lista" class="badge badge-secondary"
                                                          style="font-size: 12px">0</span>
                                                </td>
                                                <th>
                                                </th>
                                            </tr>
                                            <tr>
                                                <th width="34%">
                                                </th>
                                                <th class="text-right align-middle" width="24%">Total</th>
                                                <td class="p-0">
                                                    <div class="input-group input-group-sm">
                                                        <div class="input-group-prepend">
                                                            <div class="input-group-text">
                                                                <i class="fa fa-dollar-sign"></i>
                                                            </div>
                                                        </div>
                                                        <input type="text"
                                                               style="color: #00e765;font-weight: bolder;font-size: 14px"
                                                               placeholder='0.00'
                                                               class="form-control text-right input-lg bg-dark m-0"
                                                               id="id-total-pagar" readonly/>
                                                    </div>
                                                </td>
                                            </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                    </div>
                    <div class="card-footer text-right d-none d-sm-block">
                        <a href="javascript: if(confirm('Desea Salir del punto de Venta')){ window.location='/informe/transferencia_inventario/';}"
                           class="btn btn-secondary">
                            <i class="fa fa-arrow-left"></i> Salir
                        </a>
                    </div>
                </div>
            </article>
        </div>
    </div>
    <div class="modal fade bd-example-modal-lg" id="id-modal-guardar-documento" tabindex="-1" role="dialog"
         aria-labelledby="exampleModalCenterTitle"
         aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <form id="id-form-modal-guardar-transferencia">
                    <input type="hidden" id="id-accion-imprimir" value="1">
                    <div class="modal-header table-info p-2">
                        <h5 class="modal-title" id="exampleModalLongTitle">Guardar documento.</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="col-md ml-4" id="id-contenedor-opciones">
                            <div class="form-check">
                                <label class="form-check-label">
                                    <input type="radio" class="form-check-input" name="optradio" value="0" checked><b>PENDIENTE</b>
                                </label>
                            </div>
                            <div class="form-check">
                                <label class="form-check-label">
                                    <input type="radio" class="form-check-input" name="optradio" value="1"><b>PROCESAR</b>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <div class="col-md text-right">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">
                                <i class="fa fa-window-close"></i> Cancelar
                            </button>
                            <button id="id-btn-modal-guardar" rel="btn-accion-guardar" value="0"
                                    class="btn btn-success">
                                <i class="fa fa-save"></i> Guardar
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock %}

{% block footer %}
    <footer class="navbar navbar-expand-lg navbar-dark fixed-bottom bg-dark d-block d-sm-none p-2">
        <div class="container" id="id-foot-menu">
            <div class="col-md-7 col-7 text-white">
                Total: <b id="id-total-pagar-foot" style="color: #00e765;font-size:x-large">0.00</b>
            </div>
            <div class="col-md-5 col-5 text-center">
                <button onclick="$('#id-btn-guardar-factura').click();" data-toggle="tooltip"
                        data-placement="top"
                        title="Guardar orden de pedido" class="btn btn-success btn-block">
                    <span class="fa fa-save"></span> <b>Guardar</b>
                </button>
            </div>
        </div>
    </footer>
{% endblock %}

{% block js %}
    <script id="js-template-detalle-filtro-buscar" type="text/x-jsrender">
[%for productos%]
   <tr data-json='{"productoid":"[%:productoid%]","codigo":"[%:codigo%]","pund":"[%:precio_und%]","pcja":"[%:precio_cja%]","costo":"[%:costo_compra%]","pcjafactor":"[%:precio_cja_factor%]","stock":"[%:stock%]"}'>
    <!--td width="120"><a href="#" class="btn-block"><b>[%:codigo%]</b></a></td-->
    <td width="32" align="center" class="align-middle">
      <button type="button" data-json='{"productoid":"[%:productoid%]","codigo":"[%:codigo%]"}' class="btn btn-success btn-sm m-0 seleccionar" tabindex="0" data-toggle="tooltip" title="Seleccionar" >
          <i class="fa fa-check-circle"></i>
        </button>
    </td>
    <td width="30" class="align-middle">[%:empaque%]</td>
    <td width="200" style="max-width: calc(200 * 1vw )" class="text-truncate align-middle" title="[%:nombre%]">[%:nombre%]</td>
    <td width="35" align="center" style="max-width: calc(35 * 1vw )" class="text-truncate align-middle" title="[%:formato%]">[%:formato%]</td>
    <td width="50" align="right">[%:precio_und%]</td>
    <td width="50" align="right">[%:precio_cja%]</td>
    </tr>
[%/for%]








































































































    </script>
    <script id="js-template-detalle-transferencia" type="text/x-jsrender">
[%for items%]
 <tr>
    <td width="40" class="align-middle p-0">
       <b>[%:codigo%]</b>
    </td>
    <td width="20%" style="max-width: calc( 20 * 1vw )" class="text-truncate align-middle p-0">
        <span class="text" tabindex="0" data-toggle="tooltip" title="[%:nombre%]"><b>[%:nombre%]</b></span>
    </td>
    <td width="10%" align="center" style="max-width: calc( 10 * 1vw )" class="text-truncate align-middle p-0">
       <b>[%:formato%]</b>
    </td>
    <td width="10%" class="align-middle p-0" align="center">
       <b>[%:stock.toFixed(2)%]</b>
    </td>
    <td width="80" align="center" class="align-middle p-0">
     <div class="input-group input-group-sm m-0">
            <div class="input-group-prepend">
                <button class="btn btn-danger p-1 vmax" data-operador="-" id="minus-btn" tabindex="0" data-toggle="tooltip" title="Disminuir">
                  <i class="fa fa-minus"></i>
                </button>
            </div>
            <input type="text" placeholder="Cantidad" onkeypress="return numerico(event);" data-json='{"codigo":"[%:codigo%]","productoid":"[%:productoid%]","factor":"[%:factor%]","balanza":[%if balanza%]1[%else%]0[%/if%]}' class="form-control text-center input-number cantidad pl-1 pr-1" value="[%:cantidad%]" min="1" max="200" step="1" maxlength="6"/>
            <div class="input-group-append">
                <button class="btn btn-primary p-1 vmin" data-operador="+" id="plus-btn" tabindex="0" data-toggle="tooltip" title="Incrementar">
                  <i class="fa fa-plus"></i>
                </button>
            </div>
        </div>
    </td>
    <td width="40" align="center" class="align-middle p-0">
       <select style="width:4rem" rel="select-empaque" data-index="[%:#index%]">
          [%for empaques%]
            <option value="[%:factor%]" [%if selected %]selected[%/if%]>[%:nombre%]</option>
          [%/for%]
       </select>
    </td>

    <td width="10" align="center" class="align-middle p-0">
       <b>[%:unidades.toFixed(2)%]</b>
    </td>

    <td width="80" class="align-middle p-0" align="center">
       <b>[%:costo.toFixed(4)%]</b>
    </td>
    <td width="80" class="align-middle p-0">
        <input type="text" placeholder='0.00' style="font-size: 14px;font-weight: bold"
               class="form-control form-control-sm text-right bg-white total text-bold"
               value="[%:total.toFixed(2)%]" readonly/>
    </td>
    <td width="10" align="center" class="align-middle p-0">
        <button onclick="modelo.eliminar('[%:codigo%]','[%:productoid%]');" class="btn btn-danger btn-sm m-0 p-1" tabindex="0" data-toggle="tooltip" title="Eliminar Item" >
          <i class="fa fa-minus-circle"></i>
        </button>
    </td>
 </tr>
[%/for%]





























































































    </script>
    <script src="/static/lib/jquery.easy-autocomplete.min.js"></script>
    <script src="/static/lib/jsrender.min.js"></script>
    <script src="/static/lib/jquery.slimscroll.min.js"></script>
    <script src="/static/lib/shortcut.js"></script>
    <script src="/static/js/validador.js"></script>

{% endblock %}
{% block jscript %}
    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip();
            $.views.settings.delimiters("[%", "%]");

            $('[data-toggle-date="datepicker"]').datepicker({
                format: 'dd/mm/yyyy',
                autoHide: true,
                language: 'es-ES',
                zIndex: 2048,
                endDate: {{ hoy|date:"d/m/Y" }}
            });

            shortcut.add("f1", function () {
                let e = $('#btnAdd');
                if (!e.prop('disabled')) {
                    e.click();
                }
            });

            shortcut.add("f2", function () {
                let e = $('#id-btn-guardar-factura');
                if (!e.prop('disabled')) {
                    e.click();
                }
            });

            shortcut.add("esc", function () {
                $('#id-btn-cancelar-documento').click();
            });

            options = {
                url: function (criterio) {
                    return "/inventario/ajax/punto-venta/consultar/?accion=p-buscar-autocomplete&almacen=1&criterio=" + criterio;
                },
                listLocation: "items",
                getValue: "nombre",
                list: {
                    onClickEvent: function () {
                        let p = $('#id-filter-producto').getSelectedItemData();
                        if (p.codigo != '') {
                            $('#id-input-codigo-barra').val(p.codigo);
                            $('#id-input-codigo-barra').focus();
                            $('#id-form-producto-codigo-barra').submit();
                        }
                    },
                    onKeyEnterEvent: function () {
                        let p = $('#id-filter-producto').getSelectedItemData();
                        if (p.codigo != '') {
                            $('#id-input-codigo-barra').val(p.codigo);
                            $('#id-input-codigo-barra').focus();
                            $('#id-form-producto-codigo-barra').submit();
                        }
                    }
                },
                ajaxSettings: {
                    dataType: "json",
                    beforeSend: function () {
                    }
                },
            };

            $("#id-filter-producto").easyAutocomplete(options);

            $("div.easy-autocomplete").removeAttr('style');

            $('#id-contenedor-detalle-transferencia').slimscroll({
                height: '38vh',
            });
            $('#id-table-buscar-filtro tbody').slimscroll({
                height: '300px',
            });

            $('#btnAdd').on('click', function (e) {
                e.preventDefault();
                $('#myTabContent').prop('disabled', false);
                $('#id-btn-guardar-factura').prop('disabled', false);
                $('#btnAdd').prop('disabled', true);
                $('#id-input-codigo-barra').val('').focus();

            });

            $('#id-input-buscar-producto').on('keyup', function (e) {
                e.preventDefault();
                $.ajax({
                    url: '/inventario/ajax/punto-venta/consultar/',
                    data: {
                        accion: 'p-buscar-nombre',
                        criterio: $(this).val(),
                        bodegaid: venta.factura.bodegaid,
                        sucursalid: venta.factura.sucursalid,
                        almacen: '1'
                    },
                    beforeSend: function () {
                    },
                    method: 'GET',
                    dataType: 'json',
                }).done(function (data) {
                    if (data.resp) {
                        $.views.settings.allowCode(true);
                        var tmpl = $.templates("#js-template-detalle-filtro-buscar"); // Get compiled template
                        var html = tmpl.render(data);      // Render template using data - as HTML string
                        $("#id-table-buscar-filtro tbody").html(html);
                    }
                }).fail(function (jqXHR, textStatus) {
                    fnToast('Problemas de conexion con el servidor: ' + textStatus, 3);
                }).always(function () {
                    console.log("complete");
                });
            });

            $('#id-form-producto-codigo-barra').on({
                submit: (e) => {
                    e.preventDefault();
                    var codigo = $('#id-input-codigo-barra').val();
                    var cantidad = 1;

                    if (codigo.indexOf('+') !== -1) {
                        let arreglo = codigo.split('+');
                        codigo = String(arreglo[1]).trim();
                        cantidad = String(arreglo[0]).trim();

                        if (cantidad == null || isNaN(cantidad) || cantidad.length <= 0 || Number(cantidad) <= 0) {
                            fnToast("El valor de la cantidad ingresada no es correcto.", 3);
                            return;
                        }

                    }

                    var jqxhr = $.getJSON('/inventario/ajax/punto-venta/codigo-barra/', {
                        accion: 'producto-codigo-barra',
                        codigo: codigo
                    }).done(function (data) {
                        if (data.resp) {
                            var item = data.producto;

                            if (item.balanza) {
                                cantidad = prompt("Ingrese la cantidad", Number(cantidad).toFixed(2));

                                if (cantidad == null || isNaN(cantidad) || cantidad.length <= 0 || Number(cantidad) <= 0) {
                                    if (cantidad != null) {
                                        fnToast("El valor de la cantidad ingresada no es correcto.", 3);
                                    }
                                    $('#id-input-codigo-barra').val('').focus();
                                    return;
                                }
                            }
                            item.cantidad = Number(cantidad);

                            let cantidad_cotiza = 0;
                            if (venta.factura.controla_stock == '1') {
                                cantidad_cotiza = venta.get_cantidad(item.codigo) + item.cantidad;
                            }

                            $.ajax({
                                async: false,
                                url: '/inventario/ajax/punto-venta/consultar/',
                                data: {
                                    accion: 'p-buscar-rango',
                                    productoid: item.productoid,
                                    codigo: item.codigo,
                                    factor: item.factor,
                                    cantidad: item.cantidad,
                                    cantidad_cotiza: cantidad_cotiza,
                                    precio_lista: venta.factura.cliente.precio_lista ? 1 : 0,
                                    precio_activo: venta.factura.cliente.precio_activo,
                                    balanza: item.balanza ? 1 : 0,
                                    bodegaid: venta.factura.bodegaid,
                                    sucursalid: venta.factura.sucursalid,
                                    controla_stock: venta.factura.controla_stock
                                },
                                beforeSend: function () {
                                },
                                method: 'GET',
                                dataType: 'json',
                            }).done(function (data) {
                                if (data.resp) {

                                    item.precio = Number(data.producto.precio);
                                    item.precio_factor = Number(data.producto.precio_factor);
                                    item.precio_final = Number(data.producto.precio_final);
                                    item.stock = Number(data.producto.stock);

                                    $('#id-mensaje-producto').html('');
                                    $('#id-mensaje-display').html('');
                                    $('#id-mensaje-display').removeClass();

                                    venta.add(item);
                                    venta.actualizar();
                                    venta.set_scroll_end();
                                    $('#id-input-codigo-barra').val('').focus();

                                } else {
                                    venta.actualizar();
                                    venta.set_scroll_end();
                                    fnToast(data.error, 3);
                                }
                                $('#id-input-codigo-barra').val('').focus();

                            }).fail(function (jqXHR, textStatus) {
                                fnToast('Problemas de conexion con el servidor: ' + textStatus, 3);
                                venta.actualizar();
                                venta.set_scroll_end();
                                $('#id-input-codigo-barra').val('').focus();
                            }).always(function () {
                                console.log("complete");
                            });

                        } else {
                            $('#id-btn-show-modal-buscar').click();
                            $('#id-input-buscar-producto').val(codigo).trigger('keyup');
                        }
                    })
                        .fail(function (jqXHR, textStatus) {
                            $('#id-input-codigo-barra').val('').focus();
                            fnToast('Problemas de conexion con el servidor: ' + textStatus, 3);
                            $('#id-input-codigo-barra').val('').focus();
                        })
                        .always(function () {
                            console.log("complete");
                        });
                }
            });

            $('#id-table-buscar-filtro tbody').on('click', 'tr', function (e) {
                $(this).addClass('table-primary').siblings().removeClass('table-primary');
                let json = $(this).data('json');
                $('#id-tm-unidad').val('$' + Number(json.pund).toFixed(2));
                $('#id-tm-caja').val('$' + Number(json.pcjafactor).toFixed(2));
                $('#id-tm-stock').val(Number(json.stock).toFixed(2));
            });

            $('#id-table-buscar-filtro tbody').on('dblclick', 'tr', function (e) {
                let json = $(this).data('json');
                if (json.codigo != '') {
                    $('#id-input-codigo-barra').val(json.codigo);
                    $('#id-modal-buscar-productos').modal('hide');
                    $('#id-form-producto-codigo-barra').submit();
                    $('#id-input-codigo-barra').val('').focus();
                }
            });

            $('#id-table-buscar-filtro tbody').on('click', 'button.seleccionar', function (e) {
                let json = $(this).data('json');
                if (json.codigo != '') {
                    $('#id-input-codigo-barra').val(json.codigo);
                    $('#id-modal-buscar-productos').modal('hide');
                    $('#id-form-producto-codigo-barra').submit();
                    $('#id-input-codigo-barra').val('').focus();
                }
            });

            $('#id-modal-buscar-productos').on('hidden.bs.modal', function (e) {
                $('#id-input-codigo-barra').val('').trigger('focus');
            });

            $('#id-modal-buscar-productos').on('shown.bs.modal', function (e) {
                $('#id-input-buscar-producto').trigger('focus');
            });

            $('#id-table-detalle-transferencia > tbody').on('change', '.cantidad', function (e) {
                var element = $(this);
                if (Number(element.val()) >= 0 && element.val().length) {
                    var item = element.data('json');
                    var cantidad;
                    if (item.balanza == 1) {
                        cantidad = Number(element.val());
                    } else {
                        cantidad = Math.trunc(Number(element.val()));
                        if (cantidad <= 0) cantidad = 1;
                    }
                    item.cantidad = cantidad;
                    modelo.editar(item);
                    modelo.actualizar();
                }
            });

            $('#id-table-detalle-transferencia > tbody').on('keydown', '.cantidad', function (e) {
                var keyCode = (e.keyCode ? e.keyCode : e.which);
                if (keyCode == 13) {
                    var element = $(this);
                    if (Number(element.val()) >= 0 && element.val().length) {
                        var item = element.data('json');
                        var cantidad;
                        if (item.balanza == 1) {
                            cantidad = Number(element.val());
                        } else {
                            cantidad = Math.trunc(Number(element.val()));
                            if (cantidad <= 0) cantidad = 1;
                        }
                        item.cantidad = cantidad;
                        modelo.editar(item);
                        modelo.actualizar();
                    }
                }
            });

            $('#id-table-detalle-transferencia > tbody').on('click', 'button.vmax,button.vmin', function (e) {
                let operador = $(this).data('operador');
                let input = $(this).closest('td').find('.cantidad');
                let valor = Number(input.val());
                valor += operador == '+' ? 1 : -1;
                if (valor > 0) {
                    input.val(valor);
                } else {
                    input.val(1);
                }
                input.change();
            });

            $("input[rel=seleccion]")
                .focus(function () {
                    $(this).select();
                })
                .mouseup(function (e) {
                    e.preventDefault();
                });

            $('#id-btn-guardar-factura').on('click', function (e) {
                e.preventDefault();
                let bodega_origen = $('#id-bodega-origen');
                let bodega_destino = $('#id-bodega-destino');
                let detalle = $('#id-detalle');

                if (detalle.val() == '' || detalle.val().length <= 0) {
                    fnToast('Debe ingresar el detalle de la transferencia.', 3);
                    detalle.focus();
                    return;
                }

                if (bodega_origen.val() == '') {
                    fnToast('No ha seleccionado la bodega de origen.', 3);
                    bodega_origen.focus();
                    return;
                }

                if (bodega_destino.val() == '') {
                    fnToast('No ha seleccionado la bodega de destino.', 3);
                    bodega_destino.focus();
                    return;
                }

                modelo.transferencia.bodega_origen_id = bodega_origen.val();
                modelo.transferencia.bodega_destino_id = bodega_destino.val();
                modelo.transferencia.detalle = detalle.val();

                modelo.actualizar();
                if (modelo.transferencia.items.length <= 0) {
                    fnToast('No se ha ingresado ningun items al detalle.', 3);
                    $('#id-nombre-producto').focus();
                    return;
                }
                if (modelo.transferencia.total <= 0) {
                    fnToast('El total de la transferencia esta en cero.', 3);
                    return;
                }
                $('#id-modal-guardar-documento').modal('show');

            });

            $('#id-form-modal-guardar-transferencia').on({
                submit: function (e) {
                    e.preventDefault();

                    $('#id-btn-modal-guardar').prop('disabled', true);
                    let opcion = $('#id-contenedor-opciones').find('input:radio[name=optradio]:checked').val();
                    modelo.transferencia.fecha = $('#id-fecha').val();

                    $.ajax({
                        url: '/inventario/punto-tranferencia/crear/',
                        data: {
                            accion: "guardar-transferencia",
                            transferencia: JSON.stringify(modelo.transferencia),
                            opcion: opcion
                        },
                        method: 'POST',
                        dataType: 'json',
                    }).done(function (data) {
                        if (data.resp) {
                            fnToast('Documento guardado correctamente.. ');
                            //$('#id-modal-guardar-documento').modal('hide');
                            window.location = '/informe/transferencia_inventario/';
                            return;
                            modelo.resetForm();
                        } else {
                            fnToast(data.error, 3);
                            $('#id-btn-modal-guardar').prop('disabled', false);
                        }
                    }).fail(function (jqXHR, textStatus) {
                        $('#id-btn-modal-guardar').prop('disabled', false);
                        fnToast('Problemas de conexion con el servidor: ' + textStatus, 3);
                    }).always(function () {
                        console.log("complete");
                    });
                }
            });


           $('#id-table-detalle-transferencia > tbody').on('change', 'select[rel=select-empaque]', function (e) {
                 let index = $(this).data('index');
                 modelo.transferencia.items[index].empaque = $(this).find('option:selected').text();
                 modelo.transferencia.items[index].factor = Number($(this).val());
                 modelo.empaque_selected(index);
                 modelo.actualizar();
            });

            modelo.actualizar();
        });
        var modelo = {
            transferencia: {
                id: '{{ transferencia.id }}',
                numero: '{{ transferencia.numero }}',
                detalle: '{{ transferencia.detalle.strip }}',
                division_id: '{{ transferencia.division.id }}',
                fecha: '{{ transferencia.fecha|date:"d/m/Y" }}',
                tipo: '{{ transferencia.tipo }}',
                bodega_origen_id: "{{ transferencia.bodega_origen.id }}",
                bodega_destino_id: "{{ transferencia.bodega_destino.id }}",
                total: Number("{{ transferencia.total }}"),
                items: [
                    {% for item in transferencia.invtransferenciasdt_set.all %}
                        {
                            cantidad: Number({{ item.cantidad }}),
                            codigo: "{{ item.producto.codigo }}",
                            costo: Number("{{ item.costo|default_if_none:"0" }}"),
                            empaques : [
                                {% for e in item.producto.get_producto_empaques %}
                                    {
                                        nombre: "{{ e.nombre.strip|lower }}",
                                        factor: Number("{{ e.factor }}"),
                                        selected : {% if item.empaque.strip|lower == e.nombre.strip|lower %}true{% else %}false{% endif %}
                                    }
                                    {% if not forloop.last %},
                                    {% endif %}
                                {% endfor %}
                            ],
                            empaque: "{{ item.empaque.strip|lower }}",
                            factor: Number("{{ item.factor }}"),
                            formato: "{{ item.producto.descripcion|default_if_none:" " }}",
                            nombre: "{{ item.producto.nombre }}",
                            nombre_corto: "{{ item.producto.nombre_corto }}",
                            productoid: "{{ item.producto_id }}",
                            total: Number("{{ item.total }}"),
                            stock: Number("{{ item.get_producto_stock }}"),
                            unidades: Number("{{ item.get_producto_unidades }}"),
                        }
                        {% if not forloop.last %},
                        {% endif %}
                    {% endfor %}
                ],
                nota: '',
                pc: '',
                sucursal_id: '{{ sucursal.id }}',
                sucursal: '{{ sucursal.nombre }}',
                observacion: ''
            },
            add: function (item) {
                if (!this.existe(item)) {
                    this.transferencia.items.push(item);
                }
                return true;
            },
            existe: function (item) {
                for (var i in this.transferencia.items) {
                    if (item.productoid == this.transferencia.items[i].productoid && item.codigo == this.transferencia.items[i].codigo) {
                        this.factura.items[i].cantidad += item.cantidad;
                        return true;
                    }
                }
                return false;
            },
            editar: function (item) {
                for (var i in this.transferencia.items) {
                    if (this.transferencia.items[i].productoid == item.productoid && this.transferencia.items[i].codigo == item.codigo) {
                        this.transferencia.items[i].cantidad = item.cantidad;
                        return true;
                    }
                }
                return false;
            },
            eliminar: function (codigo, productoid) {
                for (var i in this.transferencia.items) {
                    if (this.transferencia.items[i].codigo == codigo && this.transferencia.items[i].productoid == productoid) {
                        this.transferencia.items.splice(i, 1);
                        this.actualizar();
                        return true;
                    }
                }
                return false;
            },
            eliminar_lista: function () {
                if (this.transferencia.items.length > 0) {
                    this.transferencia.items = [];
                    this.actualizar();
                }
            },
            actualizar: function () {
                this.transferencia.total = 0;
                for (var i in this.transferencia.items) {

                    this.transferencia.items[i].unidades = Math.round((this.transferencia.items[i].cantidad * this.transferencia.items[i].factor) * 100) / 100;
                    this.transferencia.items[i].costo = Math.round(this.transferencia.items[i].costo * 10000) / 10000;
                    this.transferencia.items[i].total = Math.round((this.transferencia.items[i].cantidad * this.transferencia.items[i].factor * this.transferencia.items[i].costo) * 100) / 100;
                    this.transferencia.total += this.transferencia.items[i].total;
                }
                this.transferencia.total = Math.round(this.transferencia.total * 100) / 100;
                let total_pagar = NumFormat(this.transferencia.total).toString();

                $('#id-total-pagar').val(total_pagar);
                $('#id-total-pagar-display').html('$' + total_pagar);
                $('#id-total-pagar-foot').html('$' + total_pagar);

                $('#id-items-lista').html(this.transferencia.items.length);
                this.render();

            },
            empaque_selected: function(i){
                for(e of modelo.transferencia.items[i].empaques){
                    if(e.nombre == modelo.transferencia.items[i].empaque){
                        e.selected = true;
                    }else{
                        e.selected = false;
                    }
                }
            },
            render: function () {
                var tmpl = $.templates("#js-template-detalle-transferencia"); // Get compiled template
                var html = tmpl.render(this.transferencia);      // Render template using data - as HTML string
                $("#id-table-detalle-transferencia tbody").html(html);
            },
            resetForm: function () {
                this.transferencia.detalle = '';
                this.transferencia.nota = '';
                this.transferencia.items = [];
                this.actualizar();
                $('#myTabContent').prop('disabled', true);
                $('#btnAdd').prop('disabled', false);
                $('#btnAdd').click();
            },
            set_scroll_end: function () {
                let scroll = $('#id-contenedor-detalle-transferencia');
                scroll.animate({scrollTop: scroll.prop("scrollHeight")});
            }
        };
    </script>
{% endblock %}

