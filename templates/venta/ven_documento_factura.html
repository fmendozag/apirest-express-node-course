{% extends 'base.html' %}
{% block headcss %}
    <link rel="stylesheet" href="/static/css/easy-autocomplete.min.css">
{% endblock %}

{% block header %}
    {% include 'header.html' %}
{% endblock %}

{% block main %}
    <div class="container-fluid" style="margin-top: 2.6rem">
        <div class="row">
            <div class="col-lg-12">
                <nav id="siteBreadcrumb" aria-label="breadcrumb">
                    <ol class="breadcrumb p-2">
                        <li class="breadcrumb-item"><a href="/">Inicio</a></li>
                        <li class="breadcrumb-item"><a href="/venta/factura/">Factura de ventas</a></li>
                    </ol>
                </nav>
            </div>
        </div>
        <div class="row">
            <article class="col">
                <div class="card mb-5">
                    <div class="card-header p-2 text-center">
                        <h6><i class="fa fa-file-invoice-dollar"></i> <b>Documento Factura</b></h6>
                    </div>
                    <div class="card-body p-3">
                        <div class="form-row">
                            <input type="hidden" id="id-cajaid" value="{{ caja_id }}">

                            <div class="col-md-2 col-6 mb-2">
                                <label for="id-fecha">Fecha</label>
                                <div class="input-group input-group-sm">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text">
                                            <i class="fa fa-calendar"></i>
                                        </span>
                                    </div>
                                    <input type="text" id="id-fecha" name="fecha" value="{{ hoy|date:"d/m/Y" }}"
                                           class="form-control bg-white" data-toggle="datepicker" required readonly>
                                </div>
                            </div>

                            <div class="col-md-2 col-4 col-6 mb-2">
                                <label for="id-contado">T.Pago</label>
                                <div class="input-group input-group-sm">
                                    <select id="id-contado" class="custom-select">
                                        <option value="0">CREDITO</option>
                                        <option value="1">CONTADO</option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-md-1 col-4 mb-2 d-none d-sm-block">
                                <label for="id-tipo">Tipo</label>
                                <div class="input-group input-group-sm">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text">
                                            <i class="fa fa-file"></i>
                                        </span>
                                    </div>
                                    <input type="text" id="id-tipo" name="tipo" class="form-control bg-white"
                                           value="VEN-FA" readonly>
                                </div>
                            </div>

                            <div class="col-md-2 col-4 mb-2 d-none d-sm-block">
                                <label for="id-sucursalid">Sucursal</label>
                                <div class="input-group input-group-sm">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text">
                                            <i class="fa fa-building"></i>
                                        </span>
                                    </div>
                                    <input type="hidden" id="id-sucursalid" name="sucursalid"
                                           value="{{ sucursal.codigo }}">
                                    <input type="text" id="id-sucursal" name="sucursal"
                                           class="form-control bg-white"
                                           value="{{ sucursal.nombre }}" readonly>
                                </div>
                            </div>
                            <div class="col-md-2 col-4 mb-2 text-center" style="display: none">
                                <label for="id-pagada">Pagada</label>
                                <div class="input-group input-group-sm">
                                    <label class="custom-control custom-checkbox">
                                        <input type="checkbox" name="pagada" id="id-pagada"
                                               class="custom-control-input">
                                        <span class="custom-control-indicator"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-2 mb-2">
                                <label for="id-division">División</label>
                                <div class="input-group input-group-sm">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text">
                                            <i class="fa fa-cogs"></i>
                                        </span>
                                    </div>
                                    <input type="hidden" id="id-divisionid" name="divisionid"
                                           value="{{ usuario.segusuarioparametro.caja.division.id }}">

                                    <input type="hidden" id="id-divisaid" name="divisaid"
                                           value="{{ usuario.segusuarioparametro.caja.divisa }}">

                                    <input type="text" id="id-division" name="division" class="form-control bg-white"
                                           value="{{ usuario.segusuarioparametro.caja.division.nombre }}" readonly>
                                </div>
                            </div>
                            <div class="col-md-3 mb-2">
                                <label for="id-bodegaid">Bodega</label>
                                <div class="input-group input-group-sm">
                                    <select id="id-bodegaid" name="bodegaid" class="custom-select" {% if disabled %}
                                            disabled{% endif %} required>
                                        <option value="">Seleccione</option>
                                        {% for b in bodegas %}
                                            <option value="{{ b.id }}"
                                                    {% if bodega_id == b.id %}selected{% endif %}>{{ b.nombre }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="col-md-2 mb-2">
                                <form id="id-form-cliente-ruc">
                                    <input type="hidden" name="accion" value="cliente_ruc">
                                    <label for="id-cli-ruc">Cédula/Ruc</label>
                                    <div class="input-group input-group-sm">
                                        <div class="input-group-prepend">
                                        <span class="input-group-text">
                                            <i class="fa fa-credit-card"></i>
                                        </span>
                                        </div>
                                        <input type="text" id="id-cli-ruc" name="cliente_ruc"
                                               class="form-control" maxlength="13" placeholder="999999999" required>
                                        <div class="input-group-prepend">
                                            <button id="id-btn-send-cedula-cliente" class="input-group-text">
                                                <i class="fa fa-search"></i>
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>

                            <!--div class="col-md-2 mb-2">
                                <form id="id-form-cliente-cod">
                                    <input type="hidden" name="action" value="cliente">
                                    <label for="id-cli-codigo">Cod.Cliente</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text">
                                                <i class="fa fa-qrcode"></i>
                                            </span>
                                        </div>
                                        <input type="text" id="id-cli-codigo" name="cli_codigo" maxlength="15"
                                               class="form-control" placeholder="Código"
                                               required value="">
                                        <div class="input-group-prepend">
                                            <button id="id-btn-send-cod-cliente" class="input-group-text">
                                                <i class="fa fa-search"></i>
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div-->

                            <div class="col-md-5 mb-2">
                                <label for="id-cli-nombre">Nombres del Cliente</label>
                                <!--div class="">
                                    <select id="id-select-estudiante" name="estudiante_id"
                                            class="select2-design m-2"
                                            style="width: 100%">
                                        <option value="">Buscar clientes..</option>
                                    </select>
                                </div-->
                                <div class="input-group input-group-sm">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text">
                                            <i class="fa fa-user"></i>
                                        </span>
                                    </div>
                                    <input type="text" id="id-cli-nombre" name="cliente" class="form-control"
                                           maxlength="50" placeholder="Buscar Cliente.">
                                    <div class="input-group-append">
                                        <span class="input-group-text">
                                            <i class="fa fa-search"></i>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2 col-5 mb-2 d-none d-sm-block">
                                <label for="id-cli-cupo">Cupo</label>
                                <div class="input-group input-group-sm">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text">
                                            <i class="fa fa-dollar-sign"></i>
                                        </span>
                                    </div>
                                    <input type="text" id="id-cli-cupo" name="cupo"
                                           class="form-control bg-white" placeholder="0.00" readonly>
                                </div>
                            </div>
                            <div class="col-md-3 mb-2 d-none d-sm-block">
                                <label for="id-zona">Zona</label>
                                <div class="input-group input-group-sm">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text">
                                            <i class="fa fa-map-marker"></i>
                                        </span>
                                    </div>
                                    <input type="text" id="id-zona" name="zona"
                                           class="form-control bg-white" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="form-row d-none">
                            <div class="col-md-6 mb-2">
                                <label for="id-cli-direccion">Dirección</label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text">
                                            <i class="fa fa-map-signs"></i>
                                        </span>
                                    </div>
                                    <input type="text" id="id-cli-direccion" name="direccion"
                                           class="form-control bg-white" readonly>
                                </div>
                            </div>
                            <div class="col-md-2 col-4 mb-2" style="display: none">
                                <label for="id-cod-vendedor-p">Cod.Vendedor</label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text">
                                            <i class="fa fa-qrcode"></i>
                                        </span>
                                    </div>
                                    <input type="text" id="id-cod-vendedor-p" name="codvendedor-p"
                                           class="form-control bg-white" readonly>
                                </div>
                            </div>

                            <div class="col-md-4 col-8 mb-2" style="display: none">
                                <label for="id-nombre-vendedor-p">Nombres del Vendedor</label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text">
                                            <i class="fa fa-user"></i>
                                        </span>
                                    </div>
                                    <input type="text" id="id-nombre-vendedor-p" name="vendedor-p"
                                           class="form-control bg-white" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="form-row mt-1">
                            <div class="card col p-0">
                                <div class="card-header">
                                    <div class="row mt-2">
                                        <div class="form-row p-0">
                                            <div class="col-md-2 mb-2">
                                                <form id="id-form-producto-cod">
                                                    <label for="id-cod-producto">Cod.</label>
                                                    <div class="input-group input-group-sm">
                                                        <div class="input-group-prepend">
                                                            <span class="input-group-text">
                                                                <i class="fa fa-qrcode"></i>
                                                            </span>
                                                        </div>
                                                        <input type="hidden" id="id-producto-id">
                                                        <input type="text" id="id-cod-producto" name="cod_producto"
                                                               maxlength="15"
                                                               class="form-control" placeholder="Código" required>
                                                        <div class="input-group-prepend">
                                                            <button id="id-btn-send-cod-producto"
                                                                    class="input-group-text">
                                                                <i class="fa fa-search"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <button style="display: none"></button>
                                                </form>
                                            </div>
                                            <div class="col-md-4 mb-2">
                                                <label for="id-nombre-producto">Descripción</label>
                                                <!--div class="">
                                                    <select id="id-select-producto" name="estudiante_id"
                                                            class="select2-design m-2"
                                                            style="width: 100%">
                                                        <option value="">Buscar clientes..</option>
                                                    </select>
                                                </div-->
                                                <div class="input-group input-group-sm">
                                                    <div class="input-group-prepend">
                                                        <span class="input-group-text">
                                                            <i class="fa fa-cube"></i>
                                                        </span>
                                                    </div>
                                                    <input type="text" id="id-nombre-producto" name="producto"
                                                           class="form-control"
                                                           maxlength="50" placeholder="Buscar producto">
                                                    <div class="input-group-append">
                                                        <span class="input-group-text">
                                                            <i class="fa fa-search"></i>
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-1 col-6 mb-2 d-none d-sm-block">
                                                <label for="id-stock-producto input-group-sm">Stock</label>
                                                <div class="input-group input-group-sm">
                                                    <input type="number" id="id-stock-producto" name="stock"
                                                           class="form-control bg-white" placeholder="0.00"
                                                           readonly>
                                                </div>
                                            </div>
                                            <div class="col-md-2 col-6 mb-2">
                                                <label for="id-cantidad-producto">Cantidad</label>
                                                <div class="input-group input-group-sm">
                                                    <div class="input-group-prepend">
                                                            <span class="input-group-text">
                                                                <i class="fa fa-cubes"></i>
                                                            </span>
                                                    </div>
                                                    <input type="number" id="id-cantidad-producto" name="cantidad"
                                                           maxlength="6"
                                                           class="form-control" placeholder="0.00" required>

                                                </div>
                                            </div>
                                            <div class="col-md-2 mb-2 col-6">
                                                <label for="id-precio-producto">PVP.</label>
                                                <div class="input-group input-group-sm">
                                                    <div class="input-group-prepend">
                                                        <span class="input-group-text">
                                                            <i class="fa fa-dollar-sign"></i>
                                                        </span>
                                                    </div>
                                                    <input type="number" id="id-precio-producto" name="precio"
                                                           maxlength="15"
                                                           class="form-control bg-white" placeholder="0.00" required
                                                           readonly>

                                                </div>
                                            </div>
                                            <div class="col-md-1 mb-2 pt-1">
                                                <label for="id-btn-agregar-producto"> </label>
                                                <div>
                                                    <button id="id-btn-agregar-producto"
                                                            class="btn btn-success btn-sm btn-lg btn-primary btn-block">
                                                        <i class="fa fa-plus-circle"></i> Agregar
                                                    </button>
                                                </div>

                                            </div>
                                        </div>

                                    </div>
                                </div>
                                <div class="card-body p-0 table-responsive">
                                    <table id="id-table-detalle-factura" class="table table-striped table-sm sm-0">
                                        <thead class="text-center text-sm-center thead-light small">
                                        <tr>
                                            <th class="d-none d-sm-table-cell">Item</th>
                                            <th class="d-none d-sm-table-cell">Código</th>
                                            <th>Descripción</th>
                                            <th class="d-none d-sm-table-cell">Bodega</th>
                                            <th class="d-none d-sm-table-cell">Stock</th>
                                            <th class="d-none d-sm-table-cell">Empaque</th>
                                            <th>Cant.</th>
                                            <th>PVP.</th>
                                            <th>Total</th>
                                            <th>IVA.</th>
                                            <th>Acción</th>
                                        </tr>
                                        </thead>
                                        <tbody id="det" class="table-sm small">
                                        </tbody>
                                    </table>
                                </div>
                                <div class="card-footer p-0 bg-dark">
                                    <div class="row px-3 py-1 font-weight-bold small">
                                        <div class="col-md-4 d-none d-sm-block"></div>
                                        <div class="col-md-2 col-4">
                                            <div class="text-right text-white">
                                                Comisión
                                            </div>
                                            <div id="id-total-comision" class="h5 text-right" style="color: #33FF33">
                                                $0.00
                                            </div>
                                        </div>
                                        <div class="col-md-2 col-4">
                                            <div class="text-right text-white">
                                                Subtotal
                                            </div>
                                            <div id="id-total-subtotal" class="h5 text-right" style="color: #33FF33">
                                                $0.00
                                            </div>
                                        </div>
                                        <div class="col-md-2 col-4 d-none">
                                            <div class="text-right text-white">
                                                Descuento
                                            </div>
                                            <div id="id-total-descuento" class="h5 text-right" style="color: #33FF33">
                                                $0.00
                                            </div>
                                        </div>
                                        <div class="col-md-2 col-4">
                                            <div class="text-right text-white">
                                                Impuesto
                                            </div>
                                            <div id="id-total-impuesto" class="h5 text-right" style="color: #33FF33">
                                                $0.00
                                            </div>
                                        </div>
                                        <div class="col-md-2 col-4">
                                            <div class="text-right text-white">
                                                Total
                                            </div>
                                            <div id="id-total-total" class="h5 text-right" style="color: #33FF33">
                                                $0.00
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="id-detalle">Detalle:</label>
                                    <textarea class="form-control" rows="2" id="id-detalle" maxlength="100"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer d-none d-sm-block">
                        <div class="fa-pull-right">
                            <button type="button" onclick="window.location='/'" class="btn btn-danger">
                                <i class="fa fa-arrow-left"></i>
                                Cancelar
                            </button>

                            <button id="id-btn-guardar" class="btn btn-success">
                                <i class="fa fa-save"></i>
                                Guardar Factura
                            </button>
                        </div>
                    </div>
                </div>
            </article>
        </div>
    </div>
    <div class="modal fade bd-example-modal-lg" id="id-modal-factura" tabindex="-1" role="dialog"
         aria-labelledby="exampleModalCenterTitle"
         aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
            <div class="modal-content">
                <form id="id-form-modal-factura">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLongTitle">Guardar Documento Factura</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div id="id-alert-error" class="alert alert-danger alert-dismissible fade show d-none"
                             role="alert">
                            <b id="id-mensaje-error"></b>
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <!--div class="form-row">
                            <div class="col-md mb-2 text-center">
                                <h5>Seleccione el tipo de venta</h5>
                                <div class="btn-group" data-toggle="buttons">
                                    <label class="btn btn-success" style="cursor: pointer">
                                        <input type="radio" name="options" autocomplete="off" value="1" required>
                                        <span>CREDITO DIRECTO</span>
                                    </label>
                                    <label class="btn btn-danger" style="cursor: pointer">
                                        <input type="radio" name="options" autocomplete="off" value="2">
                                        <span>PROMOCION</span>
                                    </label>
                                </div>
                            </div>
                        </div-->
                        <div class="form-row">
                            <div class="col-md-6 col-7 mb-2">
                                <label for="id-numcartilla">Cartilla</label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                <span class="input-group-text">
                                  <i class="fa fa-sort-numeric-up"></i>
                                </span>
                                    </div>
                                    <input type="text" id="id-numcartilla" name="numcartilla" autocomplete="off"
                                           class="form-control" maxlength="15" placeholder="Num.Cartilla"
                                           oninput="this.value = this.value.toUpperCase()" required>
                                </div>
                            </div>
                            <div class="col-md-6 col-5 mb-2">
                                <label for="id-dias-cobro">Dias</label>
                                <select id="id-dias-cobro" name="dias" class="custom-select"
                                        required>
                                    <option value="1">LUNES</option>
                                    <option value="2">MARTES</option>
                                    <option value="3">MIERCOLES</option>
                                    <option value="4">JUEVES</option>
                                    <option value="5">VIERNES</option>
                                    <option value="6">SABADO</option>
                                    <option value="7">DOMINGO</option>
                                </select>

                            </div>
                        </div>

                        <div class="form-row">
                            <div class="col-md-4 mb-2 d-none">
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                    <span class="input-group-text">
                                        <i class="fa fa-qrcode"></i>
                                    </span>
                                    </div>
                                    <input type="hidden" id="id-vendedorid" name="vendedorid" required>
                                    <input type="text" id="id-cod-vendedor" data-name="Vendedor" maxlength="15"
                                           class="form-control cod-emp" placeholder="Cod. Vendedor"
                                           required>
                                    <div class="input-group-append">
                                        <button id="id-btn-send-cod-vendedor" class="input-group-text">
                                            <i class="fa fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md mb-2">
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                    <span class="input-group-text">
                                        <i class="fa fa-user"></i>
                                    </span>
                                    </div>
                                    <input type="text" id="id-nombre-vendedor" name="vendedor" class="form-control"
                                           maxlength="50" placeholder="Buscar Vendedor" required>
                                    <div class="input-group-append">
                                    <span class="input-group-text">
                                        <i class="fa fa-search"></i>
                                    </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="col-md-4 mb-2 d-none">
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                    <span class="input-group-text">
                                        <i class="fa fa-qrcode"></i>
                                    </span>
                                    </div>
                                    <input type="hidden" id="id-entregadorid" name="entregadorid" required>
                                    <input type="text" id="id-cod-entregador" data-name="Entregador" maxlength="15"
                                           class="form-control cod-emp" placeholder="Cod. Entregador"
                                           required>
                                    <div class="input-group-append">
                                        <button id="id-btn-send-cod-entregador" class="input-group-text">
                                            <i class="fa fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md mb-2">
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                    <span class="input-group-text">
                                        <i class="fa fa-user"></i>
                                    </span>
                                    </div>
                                    <input type="text" id="id-nombre-entregador" name="entregador" class="form-control"
                                           maxlength="50" placeholder="Buscar Entregador" required>
                                    <div class="input-group-append">
                                    <span class="input-group-text">
                                        <i class="fa fa-search"></i>
                                    </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-row" style="display: none;">
                            <div class="col-md-4 mb-2 d-none">
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                    <span class="input-group-text">
                                        <i class="fa fa-qrcode"></i>
                                    </span>
                                    </div>
                                    <input type="hidden" id="id-verificadorid" name="verificadorid">
                                    <input type="text" id="id-cod-verificador" data-name="Verificador" maxlength="15"
                                           class="form-control cod-emp" placeholder="Cod. Verificador">
                                    <div class="input-group-append">
                                        <button id="id-btn-send-cod-verificador" class="input-group-text">
                                            <i class="fa fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md mb-2">
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                    <span class="input-group-text">
                                        <i class="fa fa-user"></i>
                                    </span>
                                    </div>
                                    <input type="text" id="id-nombre-verificador" name="verificador"
                                           class="form-control"
                                           maxlength="50" placeholder="Buscar Verificador">
                                    <div class="input-group-append">
                                    <span class="input-group-text">
                                        <i class="fa fa-search"></i>
                                    </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="col-md-4 mb-2 d-none">
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                    <span class="input-group-text">
                                        <i class="fa fa-qrcode"></i>
                                    </span>
                                    </div>
                                    <input type="hidden" id="id-cobradorid" name="cobradorid" required>
                                    <input type="text" id="id-cod-cobrador" data-name="Cobrador" maxlength="15"
                                           class="form-control cod-emp" placeholder="Cod. Cobrador"
                                           required>
                                    <div class="input-group-prepend">
                                        <button id="id-btn-send-cod-cobrador" class="input-group-text">
                                            <i class="fa fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md mb-2">
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                    <span class="input-group-text">
                                        <i class="fa fa-user"></i>
                                    </span>
                                    </div>
                                    <input type="text" id="id-nombre-cobrador" name="cobrador" class="form-control"
                                           maxlength="50" placeholder="Buscar Cobrador" required>
                                    <div class="input-group-append">
                                    <span class="input-group-text">
                                        <i class="fa fa-search"></i>
                                    </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="col-md-4 mb-2 d-none">
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                    <span class="input-group-text">
                                        <i class="fa fa-qrcode"></i>
                                    </span>
                                    </div>
                                    <input type="hidden" id="id-zonaid" name="zonaid" required>
                                    <input type="text" id="id-cod-zona" maxlength="15"
                                           class="form-control" placeholder="Cod. Zona"
                                           required>
                                    <div class="input-group-append">
                                        <button id="id-btn-send-cod-zona" class="input-group-text">
                                            <i class="fa fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-2">
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                    <span class="input-group-text">
                                        <i class="fa fa-map-marker"></i>
                                    </span>
                                    </div>
                                    <input type="text" id="id-nombre-zona" name="zona" class="form-control"
                                           maxlength="50" placeholder="Buscar Zona" required>
                                    <div class="input-group-append">
                                    <span class="input-group-text">
                                        <i class="fa fa-search"></i>
                                    </span>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">
                            <i class="fa fa-window-close"></i> Cerrar
                        </button>
                        <button id="id-btn-modal-guardar" class="btn btn-primary">
                            <i class="fa fa-save"></i> Enviar Factura
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script id="js-template-det-factura" type="text/x-jsrender">
[%* window.x = 1%]
[%for items%]
   <tr>
        <td class="d-none d-sm-table-cell" align="center">[%*: x++%]</td>
        <td class="d-none d-sm-table-cell">
          <h5><span class="badge badge-primary">[%:cod%]</span></h5>
        </td>
        <td>
          <b>[%:producto%]</b>
        </td>
        <td class="d-none d-sm-table-cell">[%:bodega%]</td>
        <td class="d-none d-sm-table-cell" align="center">
          <h5><span class="badge badge-secondary">[%:stock%]</span></h5>
        </td>
        <td class="d-none d-sm-table-cell" align="center">
          <b>[%:empaque%]</b>
        </td>
        <td align="center">
          <div class="mb-2">
            <input type="number" maxlength="6" class="form-control cantidad sm" value="[%:cantidad%]" data-json='{"id":"[%:productoid%]","stock":"[%:stock%]"}' min="1" max="100">
          </div>
        </td>
        <td align="right">
            <b>$[%:precio_display.toFixed(4)%]<b>
        </td>
        <td align="right">
          <h5>
            <span class="badge badge-primary">$[%:total.toFixed(2)%]</span>
          </h5>
        </td>
        <td align="center">
          [%if coniva == 1%]
           <i class="fa fa-check-square text-primary"></i>
          [%/if%]
        </td>
        <td align="center">
            <button onclick="venta.eliminar('[%:productoid%]');" id="id-btn-agregar-producto" class="btn btn-danger btn-sm" title="Eliminar Item" >
                <i class="fa fa-minus"></i>
            </button>
        </td>
    </tr>
  [%/for%]







    </script>
{% endblock %}

{% block footer %}
    <footer class="navbar navbar-expand-lg navbar-dark fixed-bottom bg-dark d-block d-sm-none p-2">
        <div class="container" id="id-foot-menu">
            <div class="col-md-3 col-9 text-white">
                Total: <b id="id-total-pagar" style="color: #00e765;font-size:x-large">$0.00</b>
            </div>
            <div class="col-md-3 col-3 text-center">
                <a href="#" rel="action" onclick="$('#id-btn-guardar').click();" data-toggle="tooltip"
                   data-placement="top"
                   title="Guardar Factura" class="text-white">
                    <span class="fa fa-save fa-2x"></span>
                </a>
            </div>
        </div>
    </footer>
{% endblock %}

{% block js %}
    <script src="/static/lib/jquery.easy-autocomplete.min.js"></script>
    <script src="/static/lib/jsrender.min.js"></script>
    <script src="/static/lib/shortcut.js"></script>
{% endblock %}

{% block jscript %}
    <script>
        $(function () {
            $.views.settings.delimiters("[%", "%]");
            $('#id-cli-ruc').focus();

            $('[data-toggle="datepicker"]').datepicker({
                format: 'dd/mm/yyyy',
                autoHide: true,
                language: 'es-ES',
                zIndex: 2048,
            });

            var options = {
                url: function (criterio) {
                    return "/cliente/clientes/consultar?accion=cliente_buscar&criterio=" + criterio;
                },
                listLocation: "items",
                getValue: "nombre",
                list: {
                    onClickEvent: function () {
                        var cliente = $('#id-cli-nombre').getSelectedItemData();
                        $('#id-cli-ruc').val(cliente.ruc);
                        $('#id-form-cliente-ruc').submit();
                    },
                    onKeyEnterEvent: function () {
                        var cliente = $('#id-cli-nombre').getSelectedItemData();
                        $('#id-cli-ruc').val(cliente.ruc);
                        $('#id-form-cliente-ruc').submit();
                    }
                },
                ajaxSettings: {
                    dataType: "json",
                    beforeSend: function () {
                    }
                },
            };

            $("#id-cli-nombre").easyAutocomplete(options);

            options = {
                url: function (criterio) {
                    var bodega = $('#id-bodegaid').val();
                    if (bodega == '') {
                        fnToast('Seleccione la Bodega.', 3);
                        return '';
                    }
                    return "/inventario/productos/consultar?accion=producto_buscar&criterio=" + criterio + '&bodega_id=' + bodega;
                },
                listLocation: "items",
                getValue: "producto",
                list: {
                    onClickEvent: function () {
                        var producto = $('#id-nombre-producto').getSelectedItemData();
                        $('#id-cod-producto').val(producto.cod);
                        $('#id-form-producto-cod').submit();
                    },
                    onKeyEnterEvent: function () {
                        var producto = $('#id-nombre-producto').getSelectedItemData();
                        $('#id-cod-producto').val(producto.cod);
                        $('#id-form-producto-cod').submit();
                    }
                },
                ajaxSettings: {
                    dataType: "json",
                    beforeSend: function () {
                    }
                },
            };

            $("#id-nombre-producto").easyAutocomplete(options);

            options = {
                url: function (criterio) {
                    return "/empleado/empleados/consultar?accion=empleado_buscar&criterio=" + criterio + '&tipo=entregador';
                },
                listLocation: "items",
                getValue: "nombre",
                list: {
                    maxNumberOfElements: 15,
                    onClickEvent: function (e) {
                        var empleado = $("#id-nombre-entregador").getSelectedItemData();
                        $('#id-entregadorid').val(empleado.id);
                        $('#id-cod-entregador').val(empleado.cod);
                        $('#id-nombre-cobrador').focus();

                    },
                    onKeyEnterEvent: function () {
                        var empleado = $("#id-nombre-entregador").getSelectedItemData();
                        $('#id-entregadorid').val(empleado.id);
                        $('#id-cod-entregador').val(empleado.cod);
                        $('#id-nombre-cobrador').focus();
                    }
                },
                ajaxSettings: {
                    dataType: "json",
                    beforeSend: function () {
                    },
                },
            };

            $("#id-nombre-entregador").easyAutocomplete(options);

            options = {
                url: function (criterio) {
                    return "/empleado/empleados/consultar?accion=empleado_buscar&criterio=" + criterio + '&tipo=verificador';
                },
                listLocation: "items",
                getValue: "nombre",
                list: {
                    maxNumberOfElements: 15,
                    onClickEvent: function (e) {
                        var empleado = $("#id-nombre-verificador").getSelectedItemData();
                        $('#id-verificadorid').val(empleado.id);
                        $('#id-cod-verificador').val(empleado.cod);
                        $('#id-nombre-cobrador').focus();
                    },
                    onKeyEnterEvent: function () {
                        var empleado = $("#id-nombre-verificador").getSelectedItemData();
                        $('#id-verificadorid').val(empleado.id);
                        $('#id-cod-verificador').val(empleado.cod);
                        $('#id-nombre-cobrador').focus();
                    }
                },
                ajaxSettings: {
                    dataType: "json",
                    beforeSend: function () {
                    },
                },
            };

            $("#id-nombre-verificador").easyAutocomplete(options);

            options = {
                url: function (criterio) {
                    return "/empleado/empleados/consultar?accion=empleado_buscar&criterio=" + criterio + '&tipo=vendedor';
                },
                listLocation: "items",
                getValue: "nombre",
                list: {
                    maxNumberOfElements: 15,
                    onClickEvent: function (e) {
                        var empleado = $("#id-nombre-vendedor").getSelectedItemData();
                        $('#id-vendedorid').val(empleado.id);
                        $('#id-cod-vendedor').val(empleado.cod);
                        $('#id-nombre-entregador').focus();
                    },
                    onKeyEnterEvent: function () {
                        var empleado = $("#id-nombre-vendedor").getSelectedItemData();
                        $('#id-vendedorid').val(empleado.id);
                        $('#id-cod-vendedor').val(empleado.cod);
                        $('#id-nombre-entregador').focus();
                    }
                },
                ajaxSettings: {
                    dataType: "json",
                    beforeSend: function () {
                    },
                },
            };

            $("#id-nombre-vendedor").easyAutocomplete(options);

            options = {
                url: function (criterio) {
                    return "/empleado/empleados/consultar?accion=empleado_buscar&criterio=" + criterio + '&tipo=cobrador';
                },
                listLocation: "items",
                getValue: "nombre",
                list: {
                    maxNumberOfElements: 15,
                    onClickEvent: function (e) {
                        var empleado = $("#id-nombre-cobrador").getSelectedItemData();
                        $('#id-cobradorid').val(empleado.id);
                        $('#id-cod-cobrador').val(empleado.cod);
                        $('#id-nombre-zona').focus();
                    },
                    onKeyEnterEvent: function () {
                        var empleado = $("#id-nombre-cobrador").getSelectedItemData();
                        $('#id-cobradorid').val(empleado.id);
                        $('#id-cod-cobrador').val(empleado.cod);
                        $('#id-nombre-zona').focus();
                    }
                },
                ajaxSettings: {
                    dataType: "json",
                    beforeSend: function () {
                    },
                },
            };

            $("#id-nombre-cobrador").easyAutocomplete(options);

            options = {
                url: function (criterio) {
                    return "/sistema/zonas/consultar?accion=zona_buscar&criterio=" + criterio + '&tipo=ZONAS';
                },
                listLocation: "items",
                getValue: "nombre",
                list: {
                    maxNumberOfElements: 15,
                    onClickEvent: function (e) {
                        var zona = $("#id-nombre-zona").getSelectedItemData();
                        $('#id-zonaid').val(zona.id);
                        $('#id-cod-zona').val(zona.cod);
                    },
                    onKeyEnterEvent: function () {
                        var zona = $("#id-nombre-zona").getSelectedItemData();
                        $('#id-zonaid').val(zona.id);
                        $('#id-cod-zona').val(zona.cod);
                    }
                },
                ajaxSettings: {
                    dataType: "json",
                    beforeSend: function () {
                    },
                },
            };

            $("#id-nombre-zona").easyAutocomplete(options);

            $("div.easy-autocomplete").removeAttr('style');

            /*$('#id-form-cliente-cod').on({
                submit: function (e) {
                    e.preventDefault();
                    var codigo = $('#id-cli-codigo');
                    console.log('el codi' + codigo.val());

                    if (codigo.val().trim() == '') {
                        alert('Ingrese el Código del Cliente');
                        codigo.focus();
                        return;
                    }
                    var frmData = new FormData($(this)[0]);
                    $.ajax({
                        url: '../app/cliente/ajax/cliente.php',
                        data: frmData,
                        method: 'POST',
                        dataType: 'json',
                        cache: false,
                        contentType: false,
                        processData: false
                    }).done(function (data) {
                        if (data.resp == true) {
                            var cliente = data.cliente;
                            $('#id-cli-ruc').val(cliente.ruc);
                            $('#id-cli-nombre').val(cliente.nombre);
                            //$('#id-cod-vendedor').val(cliente.vendcod);
                            //$('#id-nombre-vendedor').val(cliente.vend);
                            $('#id-zona').val(cliente.zona);
                            $('#id-cli-cupo').val(parseFloat(cliente.cupo).toFixed(2));
                            $('#id-cli-direccion').val(cliente.direc);

                            venta.factura.cliente = cliente;
                            $('#id-nombre-producto').focus();

                        } else {
                            alert(data.error);
                        }
                    }).fail(function (jqXHR, textStatus) {
                        alert('Problemas de conexion con el servidor: ' + textStatus);
                    });
                }
            });*/

            $('#id-form-cliente-ruc').on({
                submit: function (e) {
                    e.preventDefault();
                    var ruc = $('#id-cli-ruc');

                    if (ruc.val().trim() == '') {
                        fnToast('Ingrese el ruc del cliente.', 3);
                        ruc.focus();
                        return;
                    }
                    var frmData = new FormData($(this)[0]);
                    $.ajax({
                        url: '/cliente/clientes/consultar',
                        data: frmData,
                        method: 'POST',
                        dataType: 'json',
                        cache: false,
                        contentType: false,
                        processData: false
                    }).done(function (data) {
                        if (data.resp == true) {
                            var cliente = data.cliente;

                            $('#id-cli-codigo').val(cliente.cod);
                            $('#id-cli-ruc').val(cliente.ruc);
                            $('#id-cli-nombre').val(cliente.nombre);

                            $('#id-zona').val(cliente.zona);
                            $('#id-cli-cupo').val(parseFloat(cliente.cupo).toFixed(2));
                            $('#id-cli-direccion').val(cliente.direc);

                            venta.factura.cliente = cliente;
                            $('#id-nombre-producto').focus();

                        } else {
                            fnToast(data.error, 3);
                        }
                    }).fail(function (jqXHR, textStatus) {
                        fnToast('Problemas de conexion con el servidor: ' + textStatus, 3);
                    });
                }
            });

            $('#id-form-producto-cod').on({
                submit: function (e) {
                    e.preventDefault();
                    var codigo = $('#id-cod-producto');
                    var bodega = $('#id-bodegaid');

                    if (codigo.val().trim() == '' || codigo.val().length <= 0) {
                        fnToast('Ingrese código del producto.', 3);
                        codigo.focus();
                        return;
                    }
                    if (bodega.val() == '' || bodega.val().length <= 0) {
                        fnToast('Seleccione la bodega.', 3);
                        bodega.focus();
                        return;
                    }
                    $.ajax({
                        url: '/inventario/productos/consultar',
                        data: {
                            accion: 'producto_cod',
                            codigo: codigo.val(),
                            bodega_id: bodega.val(),
                            tipo: $('#id-contado').val()
                        },
                        method: 'POST',
                        dataType: 'json',
                    }).done(function (data) {
                        if (data.resp == true) {
                            console.log(data);
                            var producto = data.producto;
                            var precio = Number(producto.precio);
                            $('#id-nombre-producto').val(producto.producto);
                            $('#id-cod-producto').val(producto.cod);
                            $('#id-stock-producto').val(Number(producto.stock));
                            $('#id-precio-producto').val(precio.toFixed(4));
                            $('#id-producto-id').val(producto.id);
                            $('#id-cantidad-producto').val(1);
                            $('#id-cantidad-producto').focus();

                        } else {
                            fnToast(data.error, 3);
                        }
                    }).fail(function (jqXHR, textStatus) {
                        fnToast('Problemas de conexion con el servidor: ' + textStatus, 3);
                    });
                }
            });

            $('#id-btn-agregar-producto').on({
                click: function (e) {
                    e.preventDefault();

                    var productoid = $('#id-producto-id');
                    var codigo = $('#id-cod-producto');
                    var bodega = $('#id-bodegaid');

                    if (bodega.val() == '') {
                        fnToast('Seleccione la Bodega.', 3);
                        bodega.focus();
                        return;
                    }

                    if (productoid.val() == '') {
                        fnToast('No ha seleccionado ningun producto.', 3);
                        codigo.focus();
                        return;
                    }

                    if (codigo.val().trim() == '') {
                        fnToast('No ha seleccionado ningun producto.', 3);
                        codigo.focus();
                        return;
                    }

                    var cantidad = $('#id-cantidad-producto');
                    var precio = $('#id-precio-producto');

                    if (cantidad.val().trim() == '' || cantidad.val().length <= 0) {
                        fnToast('Cantidad no valida.', 3);
                        cantidad.focus();
                        return;
                    }
                    if (precio.val().trim() == '' || precio.val().length <= 0) {
                        fnToast('Precio no valido.', 3);
                        precio.focus();
                        return;
                    }

                    var cant = parseFloat(cantidad.val());
                    var pvp = Math.round((Number(precio.val())) * 100 + Number.EPSILON) / 100;

                    if (isNaN(cant)) {
                        fnToast('Cantidad no valida.', 3);
                        cantidad.focus();
                        return;
                    }
                    if (isNaN(pvp)) {
                        fnToast('Precio no valido.', 3);
                        precio.focus();
                        return;
                    }

                    if (cant <= 0) {
                        fnToast('La Cantidad ingresada debe ser mayor a cero.', 3);
                        cantidad.focus();
                        return;
                    }

                    if (pvp <= 0) {
                        fnToast('El Precio del producto debe ser mayor a cero.', 3);
                        precio.focus();
                        return;
                    }

                    $.ajax({
                        url: '/inventario/productos/consultar',
                        data: {
                            accion: 'producto_cod_all',
                            codigo: codigo.val(),
                            bodega_id: bodega.val(),
                            tipo: $('#id-contado').val(),
                        },
                        method: 'POST',
                        dataType: 'json',
                    }).done(function (data) {

                        if (data.resp == true) {
                            var producto = data.producto;
                            var stock = parseFloat(producto.stock);
                            if (cant > stock) {
                                fnToast('La canidad ingresada no puede ser mayor que el Stock', 3);
                                cantidad.focus();
                                return false;
                            }
                            producto.productoid = producto.id;
                            producto.stock = stock;
                            producto.cantidad = cant;
                            producto.precio = Number(producto.precio);
                            producto.costo = Number(producto.costo);
                            producto.bodegaid = bodega.val();
                            producto.bodega = $('#id-bodegaid option:selected').text();
                            producto.cupones = 0;
                            producto.valorcupon = 0;
                            producto.precioname = producto.empaque;
                            producto.factor = 1;
                            producto.detalle_ex = '';
                            producto.tasaimpuesto = Number(producto.tasaimpuesto);

                            {#producto.porc_comi_pvp_contado = Math.round((Number(producto.porc_comi_pvp_contado)) * 100 + Number.EPSILON) / 100;#}
                            {#producto.porc_comi_pvp_credito = Math.round((Number(producto.porc_comi_pvp_credito)) * 100 + Number.EPSILON) / 100;#}
                            {##}
                            {#producto.rent_pvp_contado = Math.round((Number(producto.rent_pvp_contado)) * 100 + Number.EPSILON) / 100;#}
                            {#producto.rent_pvp_credito = Math.round((Number(producto.rent_pvp_credito)) * 100 + Number.EPSILON) / 100;#}

                            venta.add(producto);
                            venta.actualizar();

                            $('#id-producto-id').val('');
                            $('#id-cod-producto').val('');
                            $('#id-stock-producto').val('');
                            $('#id-cantidad-producto').val('');
                            $('#id-precio-producto').val('');
                            $('#id-nombre-producto').val('').focus();
                        } else {
                            fnToast(data.error, 3);
                        }
                    }).fail(function (jqXHR, textStatus) {
                        fnToast('Problemas de conexion con el servidor: ' + textStatus, 3);
                    });
                }
            });

            $('#id-table-detalle-factura > tbody').on('change', '.cantidad', function (e) {
                var value = $(this).val();
                var cantidad = 1;
                if (value != '') {
                    cantidad = parseFloat(value);
                }
                var data = $(this).data('json');
                var stock = parseFloat(data.stock);
                if (cantidad > stock) {
                    cantidad = stock;
                } else {
                    if (cantidad <= 0) {
                        cantidad = 1;
                    }
                }
                venta.editar({productoid: data.id, cantidad: cantidad});
                venta.actualizar();
            });

            $('#id-btn-guardar').on('click', function (e) {
                e.preventDefault();
                if (Object.keys(venta.factura.cliente).length <= 0) {
                    fnToast('No ha seleccionado ningun cliente.', 3);
                    $('#id-cli-codigo').focus();
                    return;
                }

                venta.actualizar();
                var cupo = parseFloat(venta.factura.cliente.cupo);
                if (cupo < venta.factura.total) {
                    fnToast('El valor de la Factura excede el cupo permitido.', 3);
                    return;
                }

                if (venta.factura.items.length <= 0) {
                    fnToast('No se ha ingresado ningun items al detalle.', 3);
                    $('#id-nombre-producto').focus();
                    return;
                }

                if (venta.factura.total <= 0) {
                    fnToast('El total de la Factura esta en cero.', 3);
                    return;
                }

                var bodega = $('#id-bodegaid');
                if (bodega.val() == '') {
                    fnToast('Seleccione la bodega.', 3);
                    return;
                }
                if ($('#id-divisionid').val() == '') {
                    fnToast('No se encuentra división ID.', 3);
                    return;
                }

                /*if (venta.factura.cliente.vendid == null || venta.factura.cliente.vendid == '') {
                 alert('No se encuentra Vendedor ID');
                 return;
                 }*/

                $('input[type=radio]').prop("checked", false);

                $('#id-modal-factura').modal('show');
                $('#id-numcartilla').focus();

            });

            $('#id-cantidad-producto').on('keypress', function (e) {
                var keycode = e.keyCode || e.which || e.charCode;
                if (keycode == '13') {
                    $('#id-btn-agregar-producto').click();
                }
            });

            $('#id-precio-producto').on('keypress', function (e) {
                var keycode = e.keyCode || e.which || e.charCode;
                if (keycode == '13') {
                    $('#id-btn-agregar-producto').click();
                }
            });

            $('#id-numcartilla').on('keypress', function (e) {
                var keycode = e.keyCode || e.which || e.charCode;
                if (keycode == '13') {
                    $('#id-nombre-vendedor').focus();
                }
            });

            /*$('#id-modal-factura .cod-emp').on('change', function (e) {
                e.preventDefault();

                $('#id-alert-error').addClass('d-none');
                var element = $(this);
                var value = element.val().trim();

                if (value != '' && value.length) {
                    var tipo = element.data('name');

                    $.ajax({
                        url: '../app/empleado/ajax/empleado.php',
                        data: {action: 'empleado', codigo: value, tipo: tipo},
                        method: 'GET',
                        dataType: 'json',
                    }).done(function (data) {

                        if (data.resp == true) {

                            switch (tipo.toLowerCase()) {
                                case 'entregador':
                                    $('#id-entregadorid').val(data.empleado.id);
                                    $('#id-cod-entregador').val(data.empleado.cod);
                                    $('#id-nombre-entregador').val(data.empleado.nombre);
                                    $('#id-cod-vendedor').focus();
                                    break;

                                case 'verificador':
                                    $('#id-verificadorid').val(data.empleado.id);
                                    $('#id-cod-verificador').val(data.empleado.cod);
                                    $('#id-nombre-verificador').val(data.empleado.nombre);
                                    $('#id-cod-cobrador').focus();
                                    break;

                                case 'vendedor':
                                    $('#id-vendedorid').val(data.empleado.id);
                                    $('#id-cod-vendedor').val(data.empleado.cod);
                                    $('#id-nombre-vendedor').val(data.empleado.nombre);
                                    $('#id-cod-cobrador').focus();
                                    break;

                                case 'cobrador':
                                    $('#id-cobradorid').val(data.empleado.id);
                                    $('#id-cod-cobrador').val(data.empleado.cod);
                                    $('#id-nombre-cobrador').val(data.empleado.nombre);
                                    $('#id-cod-zona').focus();
                            }

                        } else {
                            $('#id-alert-error').removeClass('d-none');
                            $('#id-mensaje-error').html(data.error);
                            element.focus();
                        }
                    }).fail(function (jqXHR, textStatus) {
                        fnToast('Problemas de conexion con el servidor: ' + textStatus, 3);
                    });
                }
            });*/

            $('#id-cod-zona').on('change', function (e) {
                e.preventDefault();

                $('#id-alert-error').addClass('d-none');
                var value = $(this).val().trim();
                if (value != '' && value.length) {
                    $.ajax({
                        url: '../app/sistema/ajax/sistema.php',
                        data: {
                            action: 'zona_cod',
                            codigo: value,
                            tipo: 'ZONAS'
                        },
                        method: 'GET',
                        dataType: 'json',
                    }).done(function (data) {
                        if (data.resp == true) {
                            $('#id-zonaid').val(data.zona.id);
                            $('#id-cod-zona').val(data.zona.cod);
                            $('#id-nombre-zona').val(data.zona.nombre);
                        } else {
                            $('#id-alert-error').removeClass('d-none');
                            $('#id-mensaje-error').html(data.error);
                            $('#id-cod-zona').focus();
                        }
                    }).fail(function (jqXHR, textStatus) {
                        fnToast('Problemas de conexion con el servidor: ' + textStatus, 3);
                    });
                }
            });

            $('#id-form-modal-factura').on({
                submit: function (e) {
                    e.preventDefault();
                    $('#id-alert-error').addClass('d-none');

                    var sucursal = $('#id-sucursalid');
                    var division = $('#id-divisionid');
                    var divisa = $('#id-divisaid');
                    var bodega = $('#id-bodegaid');
                    var fecha = $('#id-fecha');
                    var tipo = $('#id-tipo');
                    var detalle = $('#id-detalle');
                    var contado = $('#id-contado');
                    var cajaid = $('#id-cajaid');

                    var numcartilla = $('#id-numcartilla');
                    var entregador = $('#id-entregadorid');
                    var verificador = $('#id-verificadorid');
                    var vendedor = $('#id-vendedorid');

                    var cobrador = $('#id-cobradorid');
                    var zona = $('#id-zonaid');
                    var diacobro = $('#id-dias-cobro');

                    if ($('input[name=options]:checked').length < 0) {
                        $('#id-alert-error').removeClass('d-none');
                        $('#id-mensaje-error').html('Seleccione el tipo de venta.');
                        return;
                    }

                    if (division.val().trim() == '' || division.val().length <= 0) {
                        $('#id-alert-error').removeClass('d-none');
                        $('#id-mensaje-error').html('No se Encontró División Id.');
                        return;
                    }

                    if (numcartilla.val().trim() == '' || numcartilla.val().length <= 0) {
                        $('#id-alert-error').removeClass('d-none');
                        $('#id-mensaje-error').html('Ingrese Número de Cartilla.');
                        numcartilla.focus();
                        return;
                    }

                    if (entregador.val().trim() == '' || entregador.val().length <= 0) {
                        $('#id-alert-error').removeClass('d-none');
                        $('#id-mensaje-error').html('Seleccione Entregador.');
                        $('#id-cod-entregador').focus();
                        return;
                    }

                    /*if (verificador.val().trim() == '' || verificador.val().length <= 0) {
                     $('#id-alert-error').removeClass('d-none');
                     $('#id-mensaje-error').html('Seleccione Verificador.');
                     $('#id-cod-verificador').focus();
                     return;
                     }*/

                    if (vendedor.val().trim() == '' || vendedor.val().length <= 0) {
                        $('#id-alert-error').removeClass('d-none');
                        $('#id-mensaje-error').html('Seleccione Vendedor.');
                        $('#id-cod-vendedor').focus();
                        return;
                    }

                    if (cobrador.val().trim() == '' || cobrador.val().length <= 0) {
                        $('#id-alert-error').removeClass('d-none');
                        $('#id-mensaje-error').html('Seleccione Cobrador.');
                        $('#id-cod-cobrador').focus();
                        return;
                    }

                    if (zona.val().trim() == '' || zona.val().length <= 0) {
                        $('#id-alert-error').removeClass('d-none');
                        $('#id-mensaje-error').html('Seleccione Zona.');
                        $('#id-cod-zona').focus();
                        return;
                    }

                    if ($('#id-pagada').is(":checked")) {
                        venta.factura.pagada = 1;
                    } else {
                        venta.factura.pagada = 0;
                    }

                    venta.factura.sucursalid = sucursal.val();
                    venta.factura.divisionid = division.val();
                    venta.factura.divisaid = divisa.val();
                    venta.factura.bodegaid = bodega.val();
                    venta.factura.fecha = fecha.val();
                    venta.factura.vencimiento = fecha.val();
                    venta.factura.tipo = tipo.val();
                    venta.factura.detalle = detalle.val();
                    venta.factura.contado = contado.val();
                    venta.factura.vence = fecha.val();
                    venta.factura.valor = venta.factura.total;
                    venta.factura.saldo = venta.factura.total;
                    venta.factura.cajaid = cajaid.val();
                    venta.factura.clienteid = venta.factura.cliente.id;
                    venta.factura.vendedorid = vendedor.val();
                    venta.factura.terminoid = venta.factura.cliente.terminoid;
                    venta.factura.numcartilla = numcartilla.val().toUpperCase();
                    venta.factura.entregadorid = entregador.val();
                    venta.factura.verificadorid = verificador.val();
                    venta.factura.cobradorid = cobrador.val();
                    venta.factura.zonaid = zona.val();
                    venta.factura.diacobro = diacobro.val();
                    //venta.factura.tipo_modelo = $('input[name=options]:checked').val();

                    if (venta.factura.contado == '0') {
                        venta.factura.credito = venta.factura.total;
                    }
                    $('#id-btn-modal-guardar').attr('disabled', true);

                    console.log(venta.factura);

                    $.ajax({
                        url: '/venta/factura/crear',
                        data: {accion: 'venta_factura_crear', factura: JSON.stringify(venta.factura)},
                        method: 'POST',
                        dataType: 'json',
                    }).done(function (data) {
                        console.log(data);
                        if (data.resp == true) {
                            fnToast('Factura se guardo correctamente.');
                            $('#id-modal-factura').modal('hide');
                            venta.resetForm();
                            $('#id-cli-ruc').focus();
                        } else {
                            if (data.salir == true) {
                                window.location.reload();
                            }
                            $('#id-alert-error').removeClass('d-none');
                            $('#id-mensaje-error').html(data.error);
                        }
                        $('#id-btn-modal-guardar').attr('disabled', false);
                    }).fail(function (jqXHR, textStatus) {
                        $('#id-btn-modal-guardar').attr('disabled', false);
                        fnToast('Problemas de conexion con el servidor: ' + textStatus, 3);
                    });
                }
            });

            $('#id-contado').on('change', function () {
                venta.factura.contado = $(this).val();
                if (venta.factura.items.length > 0) {
                    venta.factura.items = [];
                    venta.actualizar();
                }
                $("#id-producto-id").val('');
                $("#id-cod-producto").val('');
                $("#id-nombre-producto").val('');
                $("#id-stock-producto").val('');
                $("#id-cantidad-producto").val('');
                $("#id-precio-producto").val('');
                $("#id-pagada").prop('checked', false);
            });
        });

        var venta = {
                factura: {
                    divisionid: '',
                    divisaid: '',
                    fecha: '',
                    vencimiento: '',
                    tipo: 'VEN-FA',
                    formapago: 'CRE',
                    bodegaid: '',
                    cliente: new Object,
                    clienteid: '',
                    vendedorid: '',
                    terminoid: '',
                    subtotal: 0,
                    descuento: 0,
                    impuesto: 0,
                    total: 0,
                    valor: 0,
                    saldo: 0,
                    costototal: 0,
                    total_comision: 0,
                    items: [],
                    detalle: '',
                    nota: 'FACTURA A CREDITO',
                    contado: '0',
                    efectivo: 0,
                    cheque: 0,
                    tarjeta: 0,
                    credito: 0,
                    cupones: 0,
                    vence: '',
                    banco: '',
                    transporte: '',
                    cajaid: '',
                    numcartilla: '',
                    entregadorid: '',
                    verificadorid: '',
                    pagada: 0,
                    cobradorid: '',
                    zonaid: '',
                    diacobro: '',
                    pc: '',
                    sucursalid: '',
                    //tipo_modelo: ''
                },
                add: function (item) {

                    if (!this.existe(item)) {
                        if (item.coniva) {

                            item.precio_display = item.precio;
                            item.precio = Math.round((item.precio / (1 + (item.tasaimpuesto / 100))) * 10000 + Number.EPSILON) / 10000;
                            item.subtotal = Math.round((item.cantidad * item.precio) * 100 + Number.EPSILON) / 100;
                            item.impuesto = Math.round((item.subtotal * (item.tasaimpuesto / 100)) * 100 + Number.EPSILON) / 100;
                            item.total = Math.round((item.subtotal + item.impuesto) * 100 + Number.EPSILON) / 100;

                        } else {

                            item.precio_display = item.precio;
                            item.subtotal = Math.round((item.cantidad * item.precio) * 100 + Number.EPSILON) / 100;
                            item.total = item.subtotal;
                            item.impuesto = 0;

                        }
                        item.tasadescuento = 0;
                        item.descuento = 0;
                        this.factura.items.push(item);
                    }
                    return true;
                },
                existe: function (item) {

                    for (var i in this.factura.items) {

                        if (item.productoid == this.factura.items[i].productoid) {

                            var stock = this.factura.items[i].stock;
                            var cantidad = this.factura.items[i].cantidad;
                            if ((cantidad + item.cantidad) > stock) {
                                return true;
                            }
                            this.factura.items[i].cantidad += item.cantidad;

                            if (this.factura.items[i].coniva) {

                                this.factura.items[i].precio_display = item.precio;
                                this.factura.items[i].precio = Math.round((item.precio / (1 + (item.tasaimpuesto / 100))) * 10000 + Number.EPSILON) / 10000;
                                this.factura.items[i].subtotal = Math.round((this.factura.items[i].cantidad * this.factura.items[i].precio) * 100 + Number.EPSILON) / 100;
                                this.factura.items[i].impuesto = Math.round((this.factura.items[i].subtotal * (item.tasaimpuesto / 100)) * 100 + Number.EPSILON) / 100;
                                this.factura.items[i].total = Math.round((this.factura.items[i].subtotal + this.factura.items[i].impuesto) * 100 + Number.EPSILON) / 100;

                            } else {
                                this.factura.items[i].precio_display = item.precio;
                                this.factura.items[i].precio = item.precio;
                                this.factura.items[i].subtotal = Math.round((this.factura.items[i].cantidad * this.factura.items[i].precio) * 100 + Number.EPSILON) / 100;
                                this.factura.items[i].total = this.factura.items[i].subtotal;
                                this.factura.items[i].impuesto = 0;

                            }

                            this.factura.items[i].tasadescuento = 0;
                            this.factura.items[i].descuento = 0;
                            return true;
                        }
                    }
                    return false;
                },
                editar: function (item) {

                    for (var i in this.factura.items) {

                        if (item.productoid == this.factura.items[i].productoid) {

                            this.factura.items[i].cantidad = item.cantidad;

                            if (this.factura.items[i].coniva) {

                                this.factura.items[i].subtotal = Math.round((this.factura.items[i].cantidad * this.factura.items[i].precio) * 100 + Number.EPSILON) / 100;
                                this.factura.items[i].impuesto = Math.round((this.factura.items[i].subtotal * (this.factura.items[i].tasaimpuesto / 100)) * 100 + Number.EPSILON) / 100;
                                this.factura.items[i].total = Math.round((this.factura.items[i].subtotal + this.factura.items[i].impuesto) * 100 + Number.EPSILON) / 100;

                            } else {

                                this.factura.items[i].subtotal = Math.round((this.factura.items[i].cantidad * this.factura.items[i].precio) * 100 + Number.EPSILON) / 100;
                                this.factura.items[i].total = this.factura.items[i].subtotal;
                                this.factura.items[i].impuesto = 0;

                            }

                            this.factura.items[i].tasadescuento = 0;
                            this.factura.items[i].descuento = 0;
                            return true;
                        }
                    }
                    return false;
                },
                eliminar: function (id) {
                    for (var i in this.factura.items) {
                        if (this.factura.items[i].productoid == id) {
                            this.factura.items.splice(i, 1);
                            this.actualizar();
                            return true;
                        }
                    }
                    return false;
                },
                actualizar: function () {

                    this.factura.subtotal = 0;
                    this.factura.descuento = 0;
                    this.factura.impuesto = 0;
                    this.factura.total = 0;
                    this.factura.costototal = 0;
                    this.factura.total_comision = 0;

                    for (var i in this.factura.items) {

                        this.factura.subtotal += this.factura.items[i].subtotal;
                        this.factura.impuesto += this.factura.items[i].impuesto;
                        this.factura.total += this.factura.items[i].total;
                        this.factura.costototal += Math.round((this.factura.items[i].costo * this.factura.items[i].cantidad) * 100 + Number.EPSILON) / 100;

                        if (this.factura.contado == '0') {
                            this.factura.items[i].valor_comision = Math.round((this.factura.items[i].cantidad * this.factura.items[i].comision_credito) * 100 + Number.EPSILON) / 100;
                            this.factura.total_comision += this.factura.items[i].valor_comision;
                        } else {
                            this.factura.items[i].valor_comision = Math.round((this.factura.items[i].cantidad * this.factura.items[i].comision_contado) * 100 + Number.EPSILON) / 100;
                            this.factura.total_comision += this.factura.items[i].valor_comision;
                        }

                    }
                    this.render();

                    $('#id-total-comision').html('$' + this.factura.total_comision.toFixed(2));
                    $('#id-total-subtotal').html('$' + this.factura.subtotal.toFixed(2));
                    $('#id-total-descuento').html('$' + this.factura.descuento.toFixed(2));
                    $('#id-total-impuesto').html('$' + this.factura.impuesto.toFixed(2));
                    $('#id-total-total').html('$' + this.factura.total.toFixed(2));
                    $('#id-total-pagar').html('$' + this.factura.total.toFixed(2));

                    console.log(venta.factura);
                },
                render: function () {
                    $.views.settings.allowCode(true);
                    var tmpl = $.templates("#js-template-det-factura"); // Get compiled template
                    var html = tmpl.render(this.factura);      // Render template using data - as HTML string
                    $("#id-table-detalle-factura #det").html(html);
                }
                ,
                resetForm: function () {
                    this.factura.divisionid = '';
                    this.factura.divisaid = '';
                    this.factura.fecha = '';
                    this.factura.vencimiento = '';
                    this.factura.bodegaid = '';
                    this.factura.clienteid = '';
                    this.factura.vendedorid = '';
                    this.factura.terminoid = '';
                    this.factura.valor = 0;
                    this.factura.saldo = 0;
                    this.factura.costototal = 0;
                    this.factura.detalle = '';
                    this.factura.contado = '0';
                    this.factura.efectivo = 0;
                    this.factura.vence = '';
                    this.factura.numcartilla = '';
                    this.factura.entregadorid = '';
                    this.factura.verificadorid = '';
                    this.factura.pagada = 0;
                    this.factura.cobradorid = '';
                    this.factura.zonaid = '';
                    this.factura.diacobro = '';

                    this.total_comision = 0;

                    this.factura.cliente = new Object;
                    this.factura.items = [];
                    $("#id-table-detalle-factura #det").html('');

                    $("#id-cli-codigo").val('');
                    $("#id-cli-nombre").val('');
                    $("#id-cli-ruc").val('');
                    $("#id-cli-cupo").val('');
                    $("#id-zona").val('');
                    $("#id-cli-direccion").val('');
                    $("#id-cod-vendedor").val('');
                    $("#id-nombre-vendedor").val('');

                    $("#id-producto-id").val('');
                    $("#id-cod-producto").val('');
                    $("#id-nombre-producto").val('');
                    $("#id-stock-producto").val('');
                    $("#id-cantidad-producto").val('');
                    $("#id-precio-producto").val('');
                    $("#id-pagada").prop('checked', false);

                    $('#id-numcartilla').val('');

                    $('#id-entregadorid').val('');
                    $('#id-cod-entregador').val('');
                    $('#id-nombre-entregador').val('');

                    $('#id-verificadorid').val('');
                    $('#id-cod-verificador').val('');
                    $('#id-nombre-verificador').val('');

                    $('#id-cobradorid').val('');
                    $('#id-cod-cobrador').val('');
                    $('#id-nombre-cobrador').val('');

                    $('#id-zonaid').val('');
                    $('#id-cod-zona').val('');
                    $('#id-nombre-zona').val('');
                    $('#id-contado').val('0');
                    this.actualizar();
                    $("#id-cli-ruc").focus();
                }
            }
        ;
    </script>
{% endblock %}
